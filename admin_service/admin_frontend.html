<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard — Crowdfund</title>

  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#6ee7b7; --accent-2:#60a5fa; --danger:#fb7185; --glass: rgba(255,255,255,0.03);
    }
    html,body,#root{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#071021 0%,#081427 100%);color:#e6eef6}
    .app{display:grid;grid-template-columns:260px 1fr;gap:20px;height:100vh;padding:20px;box-sizing:border-box}
    .sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:18px;display:flex;flex-direction:column;gap:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);min-height:calc(100vh - 40px);position:sticky;top:20px}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:6px}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#04263b}
    .brand h1{font-size:16px;margin:0}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .nav button{display:block;text-align:left;padding:10px;border-radius:8px;color:var(--muted);background:transparent;border:none;font-weight:600;font-size:14px;cursor:pointer}
    .nav button.active, .nav button:hover{background:rgba(255,255,255,0.02);color:#e6f8f0}
    .main{display:flex;flex-direction:column;gap:18px;height:calc(100vh - 40px)}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px 18px;border-radius:12px;background:var(--glass);box-shadow:0 6px 18px rgba(2,6,23,0.5)}
    .search{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:10px}
    .search input{background:transparent;border:none;outline:none;color:inherit;font-size:14px;width:360px}
    .content{overflow:auto;padding:8px;border-radius:12px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(3,8,20,0.5);min-height:86px}
    .card .label{color:var(--muted);font-size:13px;margin-bottom:6px}
    .card .value{font-size:20px;font-weight:700}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(3,8,20,0.5)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:700;font-size:13px}
    .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-muted{background:rgba(255,255,255,0.04);color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    @media (max-width:1000px){.app{grid-template-columns:1fr;padding:12px}.sidebar{display:none}.grid{grid-template-columns:repeat(1,1fr)}.search input{width:140px}}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + Babel + Chart.js -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_BASE = "/admin";

    const authHeaders = () => {
      const token = localStorage.getItem("token");
      return token ? { "Authorization": "Bearer " + token } : {};
    };

    const fetchJson = async (url, opts = {}) => {
      const res = await fetch(url, opts);
      const data = await res.json().catch(() => null);
      if (!res.ok) throw { status: res.status, data };
      return data;
    };

    const Login = ({ onLogin }) => {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [error, setError] = useState("");

      async function handleLogin(e) {
        e.preventDefault();
        setError("");
        try {
          const res = await fetch(`${API_BASE}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Login failed");
          localStorage.setItem("token", data.access_token);
          onLogin(data.user);
        } catch (err) {
          setError(err.message);
        }
      }

      return (
        <div style={{display:"flex",height:"100vh",alignItems:"center",justifyContent:"center"}}>
          <div style={{width:420,background:"rgba(255,255,255,0.03)",padding:28,borderRadius:12}}>
            <h2>Admin Login</h2>
            {error && <p style={{color:"var(--danger)"}}>{error}</p>}
            <form onSubmit={handleLogin}>
              <input
                placeholder="Email"
                type="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                style={{width:"100%",marginBottom:10,padding:10,borderRadius:8,background:"transparent",border:"1px solid rgba(255,255,255,0.1)",color:"inherit"}}
              />
              <input
                placeholder="Password"
                type="password"
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                style={{width:"100%",marginBottom:14,padding:10,borderRadius:8,background:"transparent",border:"1px solid rgba(255,255,255,0.1)",color:"inherit"}}
              />
              <button className="btn" style={{background:"var(--accent-2)",color:"#04263b",width:"100%"}}>Login</button>
            </form>
          </div>
        </div>
      );
    };

    const Sidebar = ({ active, setActive }) => (
      <aside className="sidebar">
        <div className="brand">
          <div className="logo">AD</div>
          <div>
            <h1>Admin</h1>
            <div style={{color:"var(--muted)",fontSize:12}}>Crowdfund</div>
          </div>
        </div>
        <nav className="nav">
          <button className={active==="dashboard"?"active":""} onClick={()=>setActive("dashboard")}>Dashboard</button>
          <button className={active==="manage"?"active":""} onClick={()=>setActive("manage")}>Manage Admins</button>
          <button className={active==="etl"?"active":""} onClick={()=>setActive("etl")}>ETL Tools</button>
          <button className={active==="logs"?"active":""} onClick={()=>setActive("logs")}>  Activity Logs</button>
          <button className={active==="fraud"?"active":""} onClick={()=>setActive("fraud")}>Fraud Detector</button>  
        </nav>
      </aside>
    );

    // Hard-coded Dashboard for demo / local demo data
    const Dashboard = ({ user }) => {
      // static demo data (replace with real fetch later if you want)
      const demoSummary = {
        active_campaigns: 1243,
        revenue: 4523000,        // in currency units
        total_campaigns: 10000,
        total_users: 352
      };

      const demoCampaigns = [
        { title: "AI-Powered Drone Navigation System", owner: "alice@example.com", goal: 90000, raised: 1200, status: "active" },
        { title: "IoT Smart Farming Automation Kit", owner: "bob@gmail.com", goal: 45000, raised: 23000, status: "active" },
        { title: "Next-Gen EV Battery Health Monitor", owner: "carol@outlook.com", goal: 120000, raised: 40000, status: "active" },
        { title: "Wearable Health Analytics Patch", owner: "dinesh@protonmail.com", goal: 30000, raised: 1500, status: "review" },
        { title: "AR Training Simulator for Engineers", owner: "eve@yahoo.com", goal: 60000, raised: 52000, status: "active" },
        { title: "Blockchain Supply-Chain Tracker", owner: "frank@gmail.com", goal: 75000, raised: 12000, status: "suspended" },
        { title: "Portable Edge AI Inference Module", owner: "grace@company.com", goal: 50000, raised: 600, status: "draft" }
      ];

      // useState kept for compatibility if other code expects them
      const [summary, setSummary] = React.useState(demoSummary);
      const [campaigns, setCampaigns] = React.useState(demoCampaigns);

      // no effect / network call — static demo page
      React.useEffect(() => {
        // leave empty or you can later replace with fetch logic
      }, []);

      // helper to format currency (₹ shown in original)
      function fmtCurrency(n) {
        if (n == null) return "—";
        // simple formatting: add commas and a currency sign
        return "₹" + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      return (
        <div style={{ padding: 12 }}>
          <h1>Welcome, { (user && user.name) ? user.name : "Admin" }</h1>

          <div className="grid" style={{ marginTop: 12 }}>
            <div className="card">
              <div className="label">Active Campaigns</div>
              <div className="value">{summary && summary.active_campaigns}</div>
            </div>

            <div className="card">
              <div className="label">Revenue</div>
              <div className="value">{summary ? fmtCurrency(summary.revenue) : "—"}</div>
            </div>

            <div className="card">
              <div className="label">Total Campaigns</div>
              <div className="value">{summary && summary.total_campaigns}</div>
            </div>

            <div className="card">
              <div className="label">Total Users</div>
              <div className="value">{summary && summary.total_users}</div>
            </div>
          </div>

          <div className="panel" style={{ marginTop: 18 }}>
            <h2>Recent Campaigns</h2>
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Owner</th>
                  <th>Goal</th>
                  <th>Raised</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {campaigns && campaigns.length ? campaigns.map((c, i) => (
                  <tr key={i}>
                    <td>{c.title}</td>
                    <td>{c.owner}</td>
                    <td>{fmtCurrency(c.goal)}</td>
                    <td>{fmtCurrency(c.raised)}</td>
                    <td>{c.status}</td>
                  </tr>
                )) : (
                  <tr><td colSpan="5" className="small">No campaigns found</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    };


    const ManageAdmins = ({ user }) => {
      const [admins, setAdmins] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [name, setName] = useState("");
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [error, setError] = useState("");

      async function load() {
        try {
          const data = await fetchJson(`${API_BASE}/all-admins`, { headers: authHeaders() });
          setAdmins(data.admins || []);
        } catch (err) {
          console.error(err);
        }
      }

      useEffect(() => { load(); }, []);

      async function toggleStatus(id) {
        if (!confirm("Toggle admin status?")) return;
        await fetchJson(`${API_BASE}/toggle-status/${id}`, {
          method: "PUT",
          headers: authHeaders()
        });
        load();
      }

      async function deleteAdmin(id, email) {
        if (!confirm(`Delete ${email}?`)) return;
        await fetchJson(`${API_BASE}/delete/${id}`, {
          method: "DELETE",
          headers: authHeaders()
        });
        load();
      }

      async function createAdmin(e) {
        e.preventDefault();
        setError("");

        try {
          const res = await fetchJson(`${API_BASE}/register`, {
            method: "POST",
            headers: { ...authHeaders(), "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, password })
          });

          alert(res.message || "Admin created successfully");
          setShowForm(false);
          setName(""); setEmail(""); setPassword("");
          load();
        } catch (err) {
          setError((err.data && err.data.message) || "Failed to create admin");
        }
      }

      return (
        <div style={{ padding: 12 }}>
          <h2>Manage Admins</h2>

          {/* Add Admin Button */}
          <button
            className="btn"
            style={{ background: "var(--accent-2)", color: "#04263b", marginBottom: 15 }}
            onClick={() => setShowForm(!showForm)}
          >
            + Add Admin
          </button>

          {/* Simple Inline Form */}
          {showForm && (
            <div className="panel" style={{ marginBottom: 20, padding: 20 }}>
              <h3>Create New Admin</h3>

              {error && <p style={{ color: "var(--danger)" }}>{error}</p>}

              <form onSubmit={createAdmin}>
                <input
                  value={name}
                  onChange={e => setName(e.target.value)}
                  placeholder="Name"
                  required
                  style={{
                    width: "100%", marginBottom: 10, padding: 10,
                    borderRadius: 8, background: "transparent",
                    border: "1px solid rgba(255,255,255,0.1)", color: "white"
                  }}
                />

                <input
                  value={email}
                  onChange={e => setEmail(e.target.value)}
                  placeholder="Email"
                  type="email"
                  required
                  style={{
                    width: "100%", marginBottom: 10, padding: 10,
                    borderRadius: 8, background: "transparent",
                    border: "1px solid rgba(255,255,255,0.1)", color: "white"
                  }}
                />

                <input
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  placeholder="Password"
                  type="password"
                  required
                  style={{
                    width: "100%", marginBottom: 14, padding: 10,
                    borderRadius: 8, background: "transparent",
                    border: "1px solid rgba(255,255,255,0.1)", color: "white"
                  }}
                />

                <button
                  className="btn"
                  style={{ width: "100%", background: "var(--accent)", color: "#04263b" }}
                >
                  Create Admin
                </button>
              </form>
            </div>
          )}

          {/* Admin Table */}
          <div className="panel">
            <table>
              <thead>
                <tr><th>Name</th><th>Email</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody>
                {admins.length ? admins.map(a => (
                  <tr key={a._id}>
                    <td>{a.name}</td>
                    <td>{a.email}</td>
                    <td>{a.status}</td>
                    <td>
                      <button className="btn btn-muted" onClick={() => toggleStatus(a._id)}>
                        Toggle
                      </button>
                      <button
                        className="btn btn-danger"
                        style={{ marginLeft: 8 }}
                        onClick={() => deleteAdmin(a._id, a.email)}
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                )) : (
                  <tr><td colSpan="4" className="small">No admins found</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    const ETLTools = () => {
      const [extractData, setExtractData] = useState(null);
      const [transformField, setTransformField] = useState("status");
      const [transformResults, setTransformResults] = useState([]);

      // --- Extract ---
      async function handleExtract() {
        try {
          const res = await fetchJson("/admin/etl/extract", {
            method: "GET",
            headers: authHeaders()
          });
          setExtractData(res);
        } catch (err) {
          console.error(err);
          alert("Extract failed");
        }
      }

      // --- Transform ---
      async function handleTransform() {
        try {
          const res = await fetchJson("/admin/etl/transform", {
            method: "POST",
            headers: { ...authHeaders(), "Content-Type": "application/json" },
            body: JSON.stringify({ field: transformField })
          });
          setTransformResults(res.transformed || []);
        } catch (err) {
          console.error(err);
          alert("Transform failed");
        }
      }

      // --- Export ---
      function handleExport() {
        window.open("/admin/etl/export", "_blank");
      }

      return (
        <div style={{ padding: 12 }}>
          <h2>ETL Tools</h2>

          <div style={{ display: "flex", gap: 10 }}>
            <button className="btn btn-muted" onClick={handleExtract}>
              Extract
            </button>

            <input
              value={transformField}
              onChange={(e) => setTransformField(e.target.value)}
              placeholder="Group field (e.g. status)"
              style={{
                padding: 8,
                borderRadius: 8,
                background: "transparent",
                border: "1px solid rgba(255,255,255,0.1)",
                color: "white"
              }}
            />

            <button className="btn btn-muted" onClick={handleTransform}>
              Transform
            </button>

            <button className="btn btn-danger" onClick={handleExport}>
              Export CSV
            </button>
          </div>

          {/* Extract Summary */}
          {extractData && (
            <div className="panel" style={{ marginTop: 10 }}>
              <h3>Extract Summary</h3>
              <p>Users: {extractData.users_count}</p>
              <p>Campaigns: {extractData.campaigns_count}</p>
            </div>
          )}

          {/* Transform Results */}
          {transformResults.length > 0 && (
            <div className="panel" style={{ marginTop: 10 }}>
              <h3>Transform Results</h3>
              <table>
                <thead>
                  <tr>
                    <th>Field</th>
                    <th>Count</th>
                  </tr>
                </thead>
                <tbody>
                  {transformResults.map((r, i) => (
                    <tr key={i}>
                      <td>{r._id || "Unknown"}</td>
                      <td>{r.count}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );
    };

// Insert this inside the same <script type="text/babel"> where other components exist
    const ActivityLogs = () => {
        const [logs, setLogs] = useState([]);
        const [page, setPage] = useState(1);
        const [perPage, setPerPage] = useState(20);
        const [total, setTotal] = useState(0);
        const [q, setQ] = useState("");
        const [actionFilter, setActionFilter] = useState("");
        const [actionsList, setActionsList] = useState([]);
        const [loading, setLoading] = useState(false);

        async function loadLogs(p = page, size = perPage, search = q, action = actionFilter) {
          setLoading(true);
          try {
            const params = new URLSearchParams();
            params.set("page", p);
            params.set("per_page", size);
            if (search && search.length) params.set("q", search);
            if (action && action.length) params.set("action", action);

            const url = `${API_BASE}/logs?` + params.toString();
            const res = await fetchJson(url, { headers: { ...authHeaders() } });

            setLogs(res.logs || []);
            setTotal(res.total || 0);
            setPage(res.page || p);
            setPerPage(res.per_page || size);

            // collect unique actions for filter dropdown
            const uniq = {};
            const acts = [];
            (res.logs || []).forEach(l => {
              if (l.action && !uniq[l.action]) {
                uniq[l.action] = true;
                acts.push(l.action);
              }
            });
            setActionsList(acts);

          } catch (err) {
            console.error("Logs load error:", err);
            alert("Failed to load logs");
          } finally {
            setLoading(false);
          }
        }

        useEffect(() => {
          loadLogs(1, perPage, q, actionFilter);
          // eslint-disable-next-line
        }, []);

        function handleSearchSubmit(e) {
          e.preventDefault();
          loadLogs(1, perPage, q, actionFilter);
        }

        function handlePageChange(newPage) {
          loadLogs(newPage, perPage, q, actionFilter);
        }

        async function handleExportCSV() {
          try {
            const params = new URLSearchParams();
            if (q && q.length) params.set("q", q);
            if (actionFilter && actionFilter.length) params.set("action", actionFilter);
            const url = `${API_BASE}/logs/export?` + params.toString();

            // fetch blob with auth header (window.open won't send headers)
            const res = await fetch(url, { headers: { ...authHeaders() } });
            if (!res.ok) throw new Error("Export failed");
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = blobUrl;
            a.download = "admin_activity_logs.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(blobUrl);
          } catch (err) {
            console.error("Export error:", err);
            alert("CSV export failed");
          }
        }

        // default color badges for actions
        function actionBadgeStyle(action) {
          // default mapping; you said "default", so we use a simple palette.
          const map = {
            login: { background: "rgba(110,231,183,0.12)", color: "#6EE7B7", border: "1px solid rgba(110,231,183,0.08)" },
            create_admin: { background: "rgba(96,165,250,0.08)", color: "#60A5FA", border: "1px solid rgba(96,165,250,0.08)" },
            delete_admin: { background: "rgba(251,113,133,0.08)", color: "#FB7185", border: "1px solid rgba(251,113,133,0.08)" },
            update_status: { background: "rgba(253,224,71,0.06)", color: "#FDE047", border: "1px solid rgba(253,224,71,0.06)" },
            etl_export: { background: "rgba(124,58,237,0.06)", color: "#7C3AED", border: "1px solid rgba(124,58,237,0.06)" },
            etl_transform: { background: "rgba(34,197,94,0.06)", color: "#22C55E", border: "1px solid rgba(34,197,94,0.06)" }
          };
          return map[action] || { background: "rgba(255,255,255,0.02)", color: "#e6eef6", border: "1px solid rgba(255,255,255,0.03)" };
        }

        // format timestamp for display (safe parsing)
        function fmtTs(ts) {
          try {
            const d = new Date(ts);
            if (isNaN(d.getTime())) return ts || "";
            return d.toLocaleString();
          } catch (e) {
            return ts || "";
          }
        }

        const totalPages = Math.max(1, Math.ceil((total || 0) / perPage));

        return (
          <div style={{ padding: 12 }}>
            <h2>Activity Logs</h2>

            <div style={{ display: "flex", gap: 10, alignItems: "center", marginTop: 8 }}>
              <form onSubmit={handleSearchSubmit} style={{ display: "flex", gap: 8, alignItems: "center" }}>
                <input
                  placeholder="Search admin or details..."
                  value={q}
                  onChange={(e) => setQ(e.target.value)}
                  style={{ padding: 8, borderRadius: 8, border: "1px solid rgba(255,255,255,0.06)", background: "transparent", color: "inherit" }}
                />
                <select value={actionFilter} onChange={(e) => setActionFilter(e.target.value)} style={{ padding: 8, borderRadius: 8, background: "transparent", border: "1px solid rgba(255,255,255,0.06)", color: "inherit" }}>
                  <option value="">All actions</option>
                  {actionsList.map((a, idx) => <option key={idx} value={a}>{a}</option>)}
                </select>
                <button className="btn btn-muted" type="submit">Apply</button>
              </form>

              <div style={{ marginLeft: "auto", display: "flex", gap: 8 }}>
                <button className="btn btn-muted" onClick={() => { setQ(""); setActionFilter(""); loadLogs(1, perPage, "", ""); }}>Reset</button>
                <button className="btn btn-danger" onClick={handleExportCSV}>Export CSV</button>
              </div>
            </div>

            <div className="panel" style={{ marginTop: 12 }}>
              <table>
                <thead>
                  <tr>
                    <th>Admin</th>
                    <th>Action</th>
                    <th>Details</th>
                    <th>Timestamp</th>
                  </tr>
                </thead>
                <tbody>
                  {loading ? (
                    <tr><td colSpan="4" className="small">Loading…</td></tr>
                  ) : (logs && logs.length ? logs.map((l, i) => (
                    <tr key={i}>
                      <td>{l.admin}</td>
                      <td>
                        <span style={{
                          display: "inline-block",
                          padding: "6px 10px",
                          borderRadius: 8,
                          fontSize: 12,
                          fontWeight: 700,
                          ...actionBadgeStyle(l.action)
                        }}>
                          {l.action}
                        </span>
                      </td>
                      <td style={{ maxWidth: 520, whiteSpace: "pre-wrap", wordBreak: "break-word" }}>{l.details}</td>
                      <td className="small">{fmtTs(l.timestamp)}</td>
                    </tr>
                  )) : (
                    <tr><td colSpan="4" className="small">No logs found</td></tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 12 }}>
              <div className="small">Total: {total || 0} • Page {page} of {totalPages}</div>

              <div style={{ display: "flex", gap: 8 }}>
                <button className="btn btn-muted" onClick={() => handlePageChange(Math.max(1, page - 1))} disabled={page <= 1}>Prev</button>
                <button className="btn btn-muted" onClick={() => handlePageChange(Math.min(totalPages, page + 1))} disabled={page >= totalPages}>Next</button>
              </div>
            </div>
          </div>
        );
    };



    const FraudDetector = () => {
      const [items, setItems] = useState([]);
      const [loading, setLoading] = useState(false);
      const [minScore, setMinScore] = useState(0.3);
      const [selected, setSelected] = useState(null);

      async function load() {
        setLoading(true);
        try {
          const res = await fetchJson("/admin/api/fraud/flagged?min_score=" + minScore + "&limit=200", {
            headers: authHeaders()
          });
          setItems(res);
        } catch (err) {
          console.error(err);
          alert("Failed to load fraud data");
        }
        setLoading(false);
      }

      async function takeAction(id, action) {
        if (!confirm("Are you sure to " + action + " this campaign?")) return;
        try {
          await fetchJson("/admin/api/fraud/" + id + "/action", {
            method: "POST",
            headers: { ...authHeaders(), "Content-Type": "application/json" },
            body: JSON.stringify({ action, admin_user: "admin_ui" })
          });
          load();
        } catch (err) {
          console.error(err);
          alert("Action failed");
        }
      }

      async function showDetails(id) {
        try {
          const res = await fetchJson("/admin/api/fraud/" + id, {
            headers: authHeaders()
          });
          setSelected(res);
        } catch (err) {
          console.error(err);
          alert("Failed to load details");
        }
      }

      useEffect(() => { load(); }, [minScore]);

      return (
        <div style={{ padding: 12 }}>
          <h2>Fraud Detector</h2>

          {/* Table */}
          <div className="panel" style={{ marginTop: 14 }}>
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Creator</th>
                  <th>Score</th>
                  <th>Rule Hits</th>
                  <th>Actions</th>
                </tr>
              </thead>

              <tbody>
                {loading ? (
                  <tr><td colSpan="5" className="small">Loading…</td></tr>
                ) : items.length ? (
                  items.map(item => {
                    const fraud = item.fraud || {};
                    const ruleHits = fraud.rule_hits || [];
                    const score = fraud.score ? (fraud.score * 100).toFixed(1) + "%" : "—";

                    return (
                      <tr key={item._id}>
                        <td>{item.title || "-"}</td>
                        <td>{item.creator_email || item.creator_id || "-"}</td>
                        <td>{score}</td>

                        <td>
                          {ruleHits.length ? ruleHits.map(r => (
                            <div key={r.rule} className="small">{r.rule}</div>
                          )) : <span className="small">None</span>}
                        </td>

                        <td>
                          <button className="btn btn-muted" onClick={() => showDetails(item._id)}>
                            Details
                          </button>

                          <button className="btn btn-muted" style={{ marginLeft: 6 }}
                            onClick={() => takeAction(item._id, "clear")}>
                            Clear
                          </button>

                          <button className="btn btn-danger" style={{ marginLeft: 6 }}
                            onClick={() => takeAction(item._id, "suspend")}>
                            Suspend
                          </button>
                        </td>
                      </tr>
                    );
                  })
                ) : (
                  <tr><td colSpan="5" className="small">No flagged campaigns.</td></tr>
                )}
              </tbody>
            </table>
          </div>

          {/* Modal */}
          {selected && (
            <div style={{
              position: "fixed", inset: 0,
              background: "rgba(0,0,0,0.6)",
              display: "flex", alignItems: "center",
              justifyContent: "center",
              zIndex: 999
            }}>
              <div style={{
                background: "var(--card)", padding: 20,
                borderRadius: 12, width: "70%",
                maxHeight: "80%", overflow: "auto"
              }}>
                <h3>Campaign Details</h3>
                <pre style={{
                  fontSize: 12, background: "#000",
                  padding: 12, borderRadius: 8,
                  overflow: "auto", color: "lime"
                }}>
    {JSON.stringify(selected, null, 2)}
                </pre>

                <button className="btn btn-muted" style={{ marginTop: 10 }}
                  onClick={() => setSelected(null)}>
                  Close
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };



    const App = () => {
      const [user, setUser] = useState(null);
      const [active, setActive] = useState("dashboard");

      if (!localStorage.getItem("token") || !user)
        return <Login onLogin={setUser} />;

      return (
        <div className="app">
          <Sidebar active={active} setActive={setActive}/>
          <div className="main">
            <div className="topbar">
              <h2>Admin Dashboard</h2>
              <button className="btn btn-danger" onClick={()=>{
                localStorage.removeItem("token");
                window.location.reload();
              }}>Logout</button>
            </div>
            <div className="content">
              {active==="dashboard" && <Dashboard user={user}/>}
              {active==="manage" && <ManageAdmins user={user}/>}
              {active === "etl" && <ETLTools />}
              {active==="logs" && <ActivityLogs />}
              {active==="fraud" && <FraudDetector />}
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
